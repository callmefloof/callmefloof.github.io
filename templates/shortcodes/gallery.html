<div class="gallery">
  {# First pass: count image assets (jpg/png) #}
  {% set img_total = 0 %}
  {% for asset in page.assets %}
    {% if asset is matching("[.](jpg|png)$") %}
      {% set_global img_total = img_total + 1 %}
    {% endif %}
  {% endfor %}

  {# Second pass: render thumbnails and lightboxes, increment idx only for images #}
  {% set idx = 0 %}
  
  {% for asset in page.assets %}
    {% if asset is matching("[.](jpg|png)$") %}
      {% set thumb = resize_image(path=asset, width=480, height=320) %}
      {% set full = resize_image(path=asset, width=1200, height=800, op="fit") %}

      <a href="#img{{ idx }}" class="gallery-thumb">
        <img src="{{ thumb.url }}" alt="" />
      </a>

      <div class="lightbox" id="img{{ idx }}">
        <a href="#" class="close">&times;</a>
        {% if (idx - 1) < 0 %}
          {% set prev = img_total - 1 %}
        {% else %}
          {% set prev = idx - 1 %}
        {% endif %}
        {% if (idx + 1) >= img_total %}
          {% set next = 0 %}
        {% else %}
          {% set next = idx + 1 %}
        {% endif %}
        <a href="#img{{ prev }}" class="prev">&#10094;</a>
        <a href="#img{{ next }}" class="next">&#10095;</a>
        <img src="{{ asset }}" alt="" />
      </div>

      {% set_global idx = idx + 1 %}
    {% endif %}
  {% endfor %}
</div>